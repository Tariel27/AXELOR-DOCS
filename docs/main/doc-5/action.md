В предыдущей главе мы проверили представления объектов. Однако представления требуют, чтобы действия выполняли что-то полезное, а не только операции CRUD.

Действия также определяются с использованием XML и могут использоваться для изменения представлений, объектов, контроллеров вызовов или выполнения некоторых конкретных задач, таких как отправка электронной почты, импорт удаленных данных и т. д.

В этой главе мы увидим различные виды действий.

[](#concepts)Концепции
----------------------

Действия можно использовать для выполнения некоторых расширенных операций над представлением, в том числе:

*   предоставление значений по умолчанию

*   изменение значений формы

*   изменение атрибутов поля

*   вызов методов контроллера

*   проверка текущей записи


Действия можно использовать повторно. Поэтому каждому действию должно быть присвоено уникальное имя.

[](#events)События
------------------

Действия могут выполняться над различными событиями. Это включает в себя:

*   `onNew`\- при создании новой записи

*   `onLoad`\- когда запись загружается в виде формы

*   `onSave`\- когда запись собирается сохраниться

*   `onChange`\- при изменении значения поля

*   `onSelect`\- при нажатии кнопки выбора записи (только для реляционных полей)

*   `onClick`\- при нажатии на поле/кнопку


[](#context)Контекст
--------------------

Контекст — это карта пары ключ-значение текущего редактируемого объекта. Контекст может содержать некоторую дополнительную информацию, например `__parent__`контекст. Кроме того, значения многозначных полей (O2M/M2M) помечаются флажком, `selected`проверяющим, выбрана ли запись.

Доступны следующие дополнительные атрибуты: ( _новое в версии 5.4_ )

*   `_viewName`\- имя текущего представления

*   `_viewType`\- тип текущего представления

*   `_views`\- все виды, определенные текущим действием-представлением

*   `_source`\- имя источника действия (имя поля)


[](#expressions)Выражения
-------------------------

Действия xml используют динамические выражения для доступа к значениям объекта или выражения условных проверок для включения/отключения действий.

Выражение является либо:

*   заводное выражение - с префиксом`eval:`

*   выражение выбора — запросы выбора JPQL с префиксом`select:`

*   выражение действия — другое действие с префиксом`action:`

*   выражение вызова — вызов метода с префиксом`call:`

*   постоянное выражение - выражение рассматривается как постоянное значение


Эти выражения могут быть определены в синтаксисе [groovy](http://www.groovy-lang.org/) или [Java EL .](https://docs.oracle.com/javaee/7/tutorial/jsf-el.htm) Поддержка [Java EL](https://docs.oracle.com/javaee/7/tutorial/jsf-el.htm) была добавлена ​​в версии 4.0.

Мы можем смешивать оба синтаксиса выражения в одном определении действия. Правила таковы:

1.  выражения `eval:`считаются заводными выражениями

2.  выражения `select:`считаются выражением Java EL

3.  выражение, заключенное внутри `#{…​}`, считается выражением Java EL


Подробно правила:

*   `expr="eval: …​"`\- использовать заводной

*   `expr="select: …​"`\- используйте ЭЛ

*   `expr="#{…​}"`\- используйте ЭЛ

*   `expr="…​"`\- вернуть как есть (постоянно)

*   `search="…​"`\- выражение поиска `action-record`обрабатывается с помощью EL

*   `if="#{…​}"`\- используйте ЭЛ

*   `if="eval: …​"`\- использовать заводной

*   `if="select: …​"`\- используйте ЭЛ

*   `if="…​"`\- использовать заводной


Выражения EL могут использовать следующие предопределенные вспомогательные функции:

*   `is(Object, Class)`\- проверить, является ли данный объект экземпляром класса

*   `as(Object, Class)`\- приведение объекта к заданному классу (как правило, приведение в EL происходит автоматически, но полезно для преобразования контекста в класс модели)

*   `str(Object)`\- преобразовать объект в строку (если значение равно нулю, возвращается пустая строка "")

*   `imp(String)`\- импортировать класс по имени

*   `_repo_(Class)`\- получить репозиторий данного класса модели

*   `fmt:text(String, Object…​)`\- помощник по форматированию строк


Некоторые примеры:

    <action-attrs name="action-test">
      <attribute ... if="code == 'some'" expr="eval: __self__?.customer?.fullName" /> (1)
      <attribute ... if="#{code == 'some'}" expr="#{ __self__.customer.fullName }" /> (2)
      <attribute ... expr="call: com.axelor.contact.SomeController:method" /> (3)
      <attribute ... expr="select: s.fullName from Contact s where s.code = :code" /> (4)
    </action-attrs>

xml![копировать значок](../../../../_/img/octicons-16.svg#view-clippy)Скопировано!

**1**

стандартные заводные выражения

**2**

Выражение Java EL должно быть заключено внутрь `#{…​}`, также нет необходимости проверять нулевое значение.

**3**

`call:`выражения обрабатываются с помощью JavaEL

**4**

`select:`выражения обрабатываются с помощью JavaEL

Мы используем Java EL 3.0 (из tomcat8). Дополнительные сведения см. в документации [Java EL .](https://docs.oracle.com/javaee/7/tutorial/jsf-el.htm)

[](#built-ins-variables)Встроенные переменные
---------------------------------------------

Некоторые встроенные переменные доступны для использования с выражениями. Это включает в себя:

*   `__date__`\- текущая дата как`LocalDate`

*   `__time__`\- текущая дата и время как`LocalDateTime`

*   `__datetime__`\- текущая дата и время как`ZonedDateTime`

*   `__user__`\- текущий пользователь

*   `__this__`\- редактируемая запись (представляющая значения формы)

*   `__self__`\- соответствующая запись из базы данных

*   `__parent__`\- родительская запись

*   `__ref__`\- выбранная запись в режиме многообъектного поиска

*   `__id__`\- ID текущей записи

*   `__ids__`\- список идентификаторов выбранных записей

*   `__config__`\- [глобальная конфигурация контекста](../application/config.html#global-context-configuration)


[](#special-actions)Специальные действия
----------------------------------------

Для выполнения некоторых специальных операций можно использовать следующие специальные действия:

*   `sync`\- для синхронизации записи можно использовать только в начале или конце

*   `save`\- для сохранения записи можно использовать где угодно

*   `new`\- начать новую запись, можно использовать только в конце

*   `close`\- закрыть текущий вид, можно использовать только в конце

*   `validate`\- проверить текущую форму, можно использовать где угодно


Например:

    <form ...>
      ...
      <!-- save current form before executing some-action,
           and save again at the end -->
      <field name="some" onChange="save,some-action,another-action,save" />
      ...
      <!-- close current view after action is complete -->
      <field name="some" onChange="some-action,close" />
    </form>

xml![копировать значок](../../../../_/img/octicons-16.svg#view-clippy)Скопировано!